/*! roller-derby-model - v1.0.0 - 2015-03-25 Cyrille MEICHEL <cmeichel@free.fr> */var _DerbySimulator=function(){};$derby=new _DerbySimulator,function(){"undefined"!=typeof angular&&(angular.module("roller-derby",[]),angular.module("roller-derby").provider("rollerDerbyModel",[function(){var a=new _DerbySimulator;this.$get=[function(){return a}]}]),angular.module("roller-derby").directive("rollerDerbyGame",["rollerDerbyModel",function(a){return{restrict:"A",replace:!1,scope:{rollerDerbyGame:"=",interactive:"=",edit:"="},link:function(b,c){c[0].appendChild(b.rollerDerbyGame.getElement());var d=null;if(b.interactive){var e=b.rollerDerbyGame.allHumans;for(var f in e)!function(a){angular.element(a.getElement()).bind("mousedown",function(b){d={element:a,clientX:b.clientX,clientY:b.clientY}})}(e[f]);angular.element(c).bind("mousemove",function(a){null!==d&&(d.element.setPosition(null,new $derby.Vector({x:(a.clientX-d.clientX)/b.rollerDerbyGame.opt.scale,y:(a.clientY-d.clientY)/b.rollerDerbyGame.opt.scale})),d.clientX=a.clientX,d.clientY=a.clientY)}),angular.element(c).bind("mouseup",function(){d=null})}b.rollerDerbyGame.api={hideAllKeyframes:function(){var b=a.Keyframe.prototype.all;for(var c in b)a.addStyle(b[c].getElement(),{display:"none"})},toggleKeyframeShadow:function(b){var c=a.Keyframe.prototype.all;for(var d in c)c[d].shadowElement(b)},showKeyFrames:function(b){if(b){var c=b.keyFrames;for(var d in c)a.addStyle(c[d].getElement(),{display:null})}},launchAnimation:function(a,c){b.edit&&b.rollerDerbyGame.api.toggleKeyframeShadow(!0),a.selectAnimation(c),a.lauchAnimation(function(){b.edit&&b.rollerDerbyGame.api.toggleKeyframeShadow(!1)})},launchAllAnimation:function(){b.edit&&b.rollerDerbyGame.api.toggleKeyframeShadow(!0),b.rollerDerbyGame.launchAnimation(0,function(){b.edit&&b.rollerDerbyGame.api.toggleKeyframeShadow(!1)})}},b.edit&&(b.rollerDerbyGame.api.addKeyframe=function(b){var c=new a.Vector({x:0,y:0}),e=b.addKeyFrame({position:c,milliseconds:1e3});angular.element(e.getElement()).bind("mousedown",function(a){d={element:e,clientX:a.clientX,clientY:a.clientY}})})}}}]))}(),function(){var a=function(a,b){this.modelClass=_DerbySimulator.prototype.Animation.prototype,_DerbySimulator.prototype.Animation.call(this,a,b),this.keyFrames=[],this.type="bezier"};a.prototype.addKeyFrame=function(a,b){return this.modelClass.addKeyFrame.call(this,a,b)},a.prototype.stringify=function(){return this.modelClass.stringify.call(this)},a.prototype.getDuration=function(){return this.modelClass.getDuration.call(this)},a.prototype.getPoint=function(a){if("undefined"!=typeof a.index){var b=a.accuracy?a.accuracy:100;return this.getPoint({section:Math.floor(a.index/b),t:a.index/b-Math.floor(a.index/b)})}var c=parseInt(a.section,10),d=a.t;if(0===c)return new _DerbySimulator.prototype.Vector({x:this.keyFrames[0].position.x*(1-d)+(this.keyFrames[0].position.x+this.keyFrames[1].position.x)*d/2,y:this.keyFrames[0].position.y*(1-d)+(this.keyFrames[0].position.y+this.keyFrames[1].position.y)*d/2});if(c===this.keyFrames.length-1)return new _DerbySimulator.prototype.Vector({x:this.keyFrames[this.keyFrames.length-1].position.x*d+(this.keyFrames[this.keyFrames.length-1].position.x+this.keyFrames[this.keyFrames.length-2].position.x)*(1-d)/2,y:this.keyFrames[this.keyFrames.length-1].position.y*d+(this.keyFrames[this.keyFrames.length-1].position.y+this.keyFrames[this.keyFrames.length-2].position.y)*(1-d)/2});var e={x:(this.keyFrames[c-1].position.x+this.keyFrames[c].position.x)/2,y:(this.keyFrames[c-1].position.y+this.keyFrames[c].position.y)/2},f={x:(this.keyFrames[c].position.x+this.keyFrames[c+1].position.x)/2,y:(this.keyFrames[c].position.y+this.keyFrames[c+1].position.y)/2},g={x:this.keyFrames[c].position.x,y:this.keyFrames[c].position.y};return new _DerbySimulator.prototype.Vector({x:Math.pow(1-d,3)*e.x+3*d*Math.pow(1-d,2)*g.x+3*Math.pow(d,2)*(1-d)*g.x+Math.pow(d,3)*f.x,y:Math.pow(1-d,3)*e.y+3*d*Math.pow(1-d,2)*g.y+3*Math.pow(d,2)*(1-d)*g.y+Math.pow(d,3)*f.y})},a.prototype.getLength=function(a){for(var b=0,c=new _DerbySimulator.prototype.Vector(this.points[0]),d=0;d<this.points.length-1;d++)for(var e=0;1>e;e+=1/a){var f=this.getPoint({section:d,t:e});b+=c.distance(f),c=f}return b},a.prototype.interpolatePoint=function(a){var b=function(b){for(var c=b[0].milliseconds,d=1;d<b.length;d+=.5)if(c+=.5*b[Math.floor(d)].milliseconds,c>a)return Math.round(d-1);return b.length-1}(this.keyFrames,a),c=function(a,b){if(0===b)return a[0].milliseconds;for(var c=0,d=0;b>d;d++)c+=a[d].milliseconds;return c+=a[b].milliseconds/2}(this.keyFrames,b),d=function(a,b){return b===a.length-1?a[b].milliseconds/2:0===b?a[1].milliseconds/2:(a[b].milliseconds+a[b+1].milliseconds)/2}(this.keyFrames,b);return this.getPoint({section:b,t:(a-c)/(d?d:1)})},a.prototype.generatePoints=function(a){return this.modelClass.generatePoints.call(this,a)},_DerbySimulator.prototype.AnimationBezier=a}(),function(){var a=function(){this.modelClass=_DerbySimulator.prototype.Animation.prototype,_DerbySimulator.prototype.Animation.call(this,scene,options),this.keyFrames=[],this.type="linear"};a.prototype.addKeyFrame=function(a,b){return this.modelClass.addKeyFrame.call(this,a,b)},a.prototype.stringify=function(){return this.modelClass.stringify.call(this)},a.prototype.getDuration=function(){return this.modelClass.getDuration.call(this)},a.prototype.interpolatePoint=function(a){var b=function(a,b){var c=0;for(var d in a)if(c+=a[d].milliseconds,c>b)return d;return a.length-1}(this.keyFrames,a);if(0===b)return this.keyFrames[0].position;if(b>=this.keyFrames.length)return this.keyFrames[this.keyFrames.length-1].position;for(var c=0,d=0;b>d;d++)c+=this.keyFrames[d].milliseconds;var e=(a-c)/this.keyFrames[b].milliseconds;return new _DerbySimulator.prototype.Vector({x:(1-e)*this.keyFrames[b-1].position.x+e*this.keyFrames[b].position.x,y:(1-e)*this.keyFrames[b-1].position.y+e*this.keyFrames[b].position.y})},a.prototype.generatePoints=function(a){return this.modelClass.generatePoints.call(this,a)},_DerbySimulator.prototype.AnimationLinear=a}(),function(){var a=function(a,b){this.scene=a,a.registerObject(this),this.opt=_DerbySimulator.prototype.extend({marker:!1},b),this.id=_DerbySimulator.prototype.getUUID(),this.keyFrames=[]};a.prototype.addKeyFrame=function(a){var b=new _DerbySimulator.prototype.Keyframe(this,{marker:this.opt.marker||a.marker,position:a.position,milliseconds:a.milliseconds});return this.keyFrames.push(b),b},a.prototype.getDuration=function(){var a=0;for(var b in this.keyFrames)a+=this.keyFrames[b].milliseconds;return a},a.prototype.generatePoints=function(a){for(var b=[],c=0;c<this.keyFrames[0].milliseconds;c+=a)b.push(null);b.push(this.keyFrames[0].position);for(var d=this.keyFrames[0].milliseconds;d<=this.getDuration();d+=a)b.push(this.interpolatePoint(d));return b},a.prototype.interpolatePoint=function(){throw"[Animation.interpolatePoint] This is a virtual class"},a.prototype.stringify=function(){var a='{"type":"'+this.type+'","keyframes":[',b=[];for(var c in this.keyFrames)b.push(this.keyFrames[c].stringify());return a+b.join(",")+"]}"},_DerbySimulator.prototype.Animation=a}(),function(){var a=function(a,b){this.id=_DerbySimulator.prototype.getUUID(),this.scene=a,a.registerObject(this),this.opt=_DerbySimulator.prototype.extend({position:0,offset:{x:0,y:0}},b),this.chairs=0===parseInt(""+this.opt.position,10)?[new _DerbySimulator.prototype.Chair({x:1400,y:-830}),new _DerbySimulator.prototype.Chair({x:1450,y:-780}),new _DerbySimulator.prototype.Chair({x:1500,y:-730}),new _DerbySimulator.prototype.Chair({x:1550,y:-680}),new _DerbySimulator.prototype.Chair({x:1600,y:-630})]:[new _DerbySimulator.prototype.Chair({x:1400,y:800}),new _DerbySimulator.prototype.Chair({x:1450,y:750}),new _DerbySimulator.prototype.Chair({x:1500,y:700}),new _DerbySimulator.prototype.Chair({x:1550,y:650}),new _DerbySimulator.prototype.Chair({x:1600,y:600})],this.element=this.buildElement(),a.addElement(this.element)};a.prototype.getElement=function(){return this.element},a.prototype.buildElement=function(){var a;return a=0===parseInt(""+this.opt.position,10)?new _DerbySimulator.prototype.SvgElement("g",{"class":"bench",transform:"matrix(0.707 0.707 -0.707 0.707 "+(this.opt.offset.x+1400)+" "+(this.opt.offset.y-900)+")",id:this.id}):new _DerbySimulator.prototype.SvgElement("g",{"class":"bench",transform:"matrix(0.707 -0.707 0.707 0.707 "+(this.opt.offset.x+1325)+" "+(this.opt.offset.y+805)+")",id:this.id}),a.appendChild(new _DerbySimulator.prototype.SvgElement("rect",{"class":"bench",x:0,y:0,width:400,height:100})),a.appendChild(new _DerbySimulator.prototype.SvgElement("text",{fill:"green",style:"font-size:60px","class":"noselect",x:200,y:65,"text-anchor":"middle",transform:"matrix(1 0 0 1 0 0)"},document.createTextNode("Bench"))),a},_DerbySimulator.prototype.Bench=a}(),function(){var a=function(a){this.id=_DerbySimulator.prototype.getUUID(),this.position=a,this.player=null};a.prototype.isFree=function(){return null===this.player},a.prototype.setPlayer=function(a){this.player=a,a.setPosition(this.position)},a.prototype.getPlayer=function(){return this.player},_DerbySimulator.prototype.Chair=a}(),function(){var a=function(b,c){this.id=_DerbySimulator.prototype.getUUID(),this.opt=_DerbySimulator.prototype.extend({marker:!1,position:{x:0,y:0},milliseconds:1e3},c),this.animation=b,this.scene=b.scene,this.scene.registerObject(this),this.position=new _DerbySimulator.prototype.Vector(this.opt.position),this.milliseconds=this.opt.milliseconds,"undefined"==typeof a.prototype.all&&(a.prototype.all=[]),a.prototype.all.push(this),this.opt.marker&&(this.element=this.buildElement(),this.scene.addElement(this.element))};a.prototype.buildElement=function(){var a=new _DerbySimulator.prototype.svgCross(this.position,"keyframe",60,this.animation.keyFrames.length+1);return a},a.prototype.shadowElement=function(a){a?_DerbySimulator.prototype.addClass(this.getElement(),"shadow"):_DerbySimulator.prototype.removeClass(this.getElement(),"shadow")},a.prototype.getElement=function(){return this.element},a.prototype.setPosition=function(a,b){a&&(this.position=new _DerbySimulator.prototype.Vector(a)),b&&this.position.add(b),this.element&&this.element.setAttribute("transform","translate("+this.position.x+", "+this.position.y+")")},a.prototype.stringify=function(){return'{"milliseconds":'+this.milliseconds+',"position":'+this.position.stringify()+"}"},_DerbySimulator.prototype.Keyframe=a}(),function(){var a=function(a,b){this.id=_DerbySimulator.prototype.getUUID(),this.scene=a,a.registerObject(this),this.opt=_DerbySimulator.prototype.extend({},b),this.players=null,this.forward=null,this.backyard=null,this.element=this.buildElement(),a.addElement(this.element)};a.prototype.getElement=function(){return this.element},a.prototype.buildElement=function(){var a=new _DerbySimulator.prototype.SvgElement("g",{"class":"pack",id:this.id});return this.message=function(a){var b=new _DerbySimulator.prototype.SvgElement("text",{fill:"#000000",style:"font-size:100px",x:0,y:0,"text-anchor":"middle","class":"noselect"},document.createTextNode(""));return a.appendChild(b),b}(a),this.delimiter=function(a){var b=new _DerbySimulator.prototype.SvgElement("path",{d:"M 0,0"}),c=new _DerbySimulator.prototype.SvgElement("g",{"class":"pack-track","fill-rule":"evenodd","clip-path":"url(#pack-"+this.id+")"});return c.appendChild(new _DerbySimulator.prototype.SvgElement("path",{"class":"limit",d:"M -533,-777 l 1066,-62 a 808,808,180,1,1,0,1616 l -1066,62 a 808,808,180,1,1,0,-1616 z M -533,-381 l 1066,0 a 381,381,180,1,1,0,762 l -1066,0 a 381,381,180,1,1,0,-762 z"})),a.appendChild(new _DerbySimulator.prototype.SvgElement("clipPath",{id:"pack-"+this.id},b)),a.appendChild(c),b}(a),this.engagementZone=function(a){var b=new _DerbySimulator.prototype.SvgElement("g",{"class":"engagement-zone"}),c=new _DerbySimulator.prototype.SvgElement("path",{d:"M 0,0","stroke-dasharray":"30,30","class":"forward"}),d=new _DerbySimulator.prototype.SvgElement("path",{d:"M 0,0","stroke-dasharray":"30,30","class":"backyard"});return a.appendChild(b),b.appendChild(c),b.appendChild(d),{forward:c,backyard:d}}(a),a},a.prototype.setMessage=function(a){var b=this.message.childNodes[0];b.nodeValue=a?a:""},a.prototype.drawPack=function(){if(this.backyard&&this.forward){var a=function(a,b,c){switch(a.getZone()){case 1:var d=Math.PI/2+Math.atan(a.position.y/(-533-a.position.x));limitLine1=-533-1500*Math.sin(d)+","+-1500*Math.cos(d),limitLine2="L -533,0";break;case 2:limitLine1=a.position.x+",1500",limitLine2="L "+a.position.x+",0 ";break;case 3:var e=Math.PI/2-Math.atan(a.position.y/(a.position.x-533));limitLine1=533+1500*Math.sin(e)+","+1500*Math.cos(e),limitLine2="L 533,0";break;case 4:limitLine1=a.position.x+",-1500",limitLine2="L "+a.position.x+",0 "}return{str:b?limitLine2+" L "+limitLine1+" A 800 800 "+b+" 1 1 "+c:"M "+limitLine1+" "+limitLine2,point:limitLine1}},b=Math.atan(this.forward.position.y/this.forward.position.x),c=Math.atan(this.backyard.position.y/this.backyard.position.x),d=(Math.PI-(b-c))%Math.PI,e=a(this.backyard),f=e.str+" "+a(this.forward,180*d/Math.PI,e.point).str+" z";this.delimiter.setAttribute("d",f)}else this.delimiter.setAttribute("d","M 0,0")},a.prototype.drawEngagement=function(){if(this.backyard&&this.backyard){var a=this.forward.algebraicPosition().position+600+2*this.forward.opt.ray,b=this.backyard.algebraicPosition().position-600-2*this.backyard.opt.ray,c=function(a,b){var c="";switch(a.getZone(b)){case 1:var d=Math.PI/2+Math.atan(b.y/(-533-b.x));c="M "+(-533-808*Math.sin(d))+","+(-808*Math.cos(d)+31)+" L "+(-533-381*Math.sin(d))+","+-381*Math.cos(d);break;case 2:c="M "+b.x+","+(777-31*(b.x-533)/1066)+" L "+b.x+",381 ";break;case 3:var e=Math.PI/2-Math.atan(b.y/(b.x-533));c="M "+(533+808*Math.sin(e))+","+(808*Math.cos(e)-31)+" L "+(533+381*Math.sin(e))+","+381*Math.cos(e);break;case 4:c="M "+b.x+","+(-777-31*(b.x+533)/1066)+" L "+b.x+",-381 "}return c};this.engagementZone.backyard.setAttribute("d",c(this.backyard,this.backyard.algebraicToCartesian(b))),this.engagementZone.forward.setAttribute("d",c(this.forward,this.forward.algebraicToCartesian(a)))}else this.engagementZone.backyard.setAttribute("d","M 0,0"),this.engagementZone.forward.setAttribute("d","M 0,0")},a.prototype.draw=function(){this.drawPack(),this.drawEngagement()},a.prototype.compute=function(){for(var a in this.scene.allHumans)_DerbySimulator.prototype.removeClass(this.scene.allHumans[a].getElement(),"in-pack"),delete this.scene.allHumans[a].forward,delete this.scene.allHumans[a].backyard;var b=[],c=this.scene.getInTrackPlayers();for(var d in c)"jammer"!==c[d].role&&b.push(c[d]);for(var e=function(a,b){var c=!1;for(var d in a){var e=b.trackAlgebraicDistance(a[d].position);Math.abs(e)<=300+b.opt.ray+a[d].opt.ray&&(a[d].forward&&e>0&&(b.forward=!0,a[d].forward=!1),a[d].backyard&&0>e&&(b.backyard=!0,a[d].backyard=!1),c=!0)}return c},f=0,g=[],h=function(a){for(var b=1;b<a.length;b++)if(a[b].team.id!=a[0].team.id)return!0;return!1};b.length>0;){var i=b.splice(0,1);i[0].backyard=!0,i[0].forward=!0;for(var j=b.length-1;j>=0;j--)e(i,b[j])&&(i.push(b.splice(j,1)[0]),j=b.length);h(i)&&(g.push(i),i.length>f&&(f=i.length))}for(var k=g.length-1;k>=0;k--)g[k].length<f&&g.splice(k,1);if(this.players=null,this.forward=null,this.backyard=null,1===g.length){var l=g[0],m=null,n=null;for(var o in l)l[o].backyard&&(m=l[o]),l[o].forward&&(n=l[o]),_DerbySimulator.prototype.addClass(l[o].getElement(),"in-pack");this.players=l,this.forward=n,this.backyard=m,this.length=Math.abs(m.trackAlgebraicDistance(n.position))}null===this.players?this.setMessage("No pack !"):this.setMessage(),this.draw()},_DerbySimulator.prototype.Pack=a}(),function(){var a=function(a,b){this.id=_DerbySimulator.prototype.getUUID(),this.scene=a,a.registerObject(this),this.opt=_DerbySimulator.prototype.extend({offset:{x:0,y:0}},b),this.chairs=[{b1:new _DerbySimulator.prototype.Chair({x:1650,y:-110}),b2:new _DerbySimulator.prototype.Chair({x:1650,y:-180}),b3:new _DerbySimulator.prototype.Chair({x:1550,y:-145}),j:new _DerbySimulator.prototype.Chair({x:1650,y:-40})},{b1:new _DerbySimulator.prototype.Chair({x:1650,y:110}),b2:new _DerbySimulator.prototype.Chair({x:1650,y:180}),b3:new _DerbySimulator.prototype.Chair({x:1550,y:145}),j:new _DerbySimulator.prototype.Chair({x:1650,y:40})}],this.element=this.buildElement(),a.addElement(this.element)};a.prototype.getElement=function(){return this.element},a.prototype.buildElement=function(){var a=new _DerbySimulator.prototype.SvgElement("g",{"class":"penalty-box",transform:"matrix(0 -1 1 0 "+(this.opt.offset.x+1600)+" "+(this.opt.offset.y+210)+")",id:this.id});return a.appendChild(new _DerbySimulator.prototype.SvgElement("rect",{"class":"penalty-box",x:0,y:0,width:420,height:100})),a.appendChild(new _DerbySimulator.prototype.SvgElement("text",{fill:"red",style:"font-size:60px","class":"noselect",x:210,y:65,"text-anchor":"middle",transform:"matrix(1 0 0 1 0 0)"},document.createTextNode("Penalty Box"))),a},_DerbySimulator.prototype.PenaltyBox=a}(),function(){var a=function(b,c){this.id=_DerbySimulator.prototype.getUUID(),"undefined"==typeof a.prototype.all&&(a.prototype.all=[]),a.prototype.all.push(this),this.humanType="player",this.scene=b,b.registerObject(this),this.opt=_DerbySimulator.prototype.extend({ray:30,role:"blocker",position:{x:0,y:0},name:a.prototype.all.length},c),this.animations=[],this.animationControl={timeStep:50},this.name=this.opt.name,this.trajectory=[],this.position=new _DerbySimulator.prototype.Vector(this.opt.position),this.role=this.opt.role.toLowerCase(),this.team=null,b.allHumans.push(this),this.element=this.buildElement(),b.addElement(this.element),this.checkCollision(),this.isInTrack(),b.pack.compute(),this.isInEngagementZone()};a.prototype.checkCollision=function(){for(var a in this.scene.allHumans){var b=this.scene.allHumans[a];if(b.id!=this.id){var c=this.position.distance(b.position),d=c-(this.opt.ray+b.opt.ray);if(0>d){var e=new _DerbySimulator.prototype.Vector(b.position).sub(this.position).normalize().coef(1.2*Math.abs(d));b.setPosition(null,e)}}}},a.prototype.getElement=function(){return this.element},a.prototype.setPosition=function(a,b){a&&(this.position=new _DerbySimulator.prototype.Vector(a)),b&&this.position.add(b),this.element.setAttribute("transform","translate("+this.position.x+", "+this.position.y+")"),this.checkCollision(),this.isInTrack(),this.scene.pack.compute();var c=this.scene.getInTrackPlayers();for(var d in c)c[d].isInEngagementZone();var e=this.scene.getOutTrackPlayers();for(var f in e)e[f].setText(["Out of","bounce"])},a.prototype.generateTrajectory=function(a){return this.trajectory=this.animations.length>a?this.animations[a].generatePoints(this.animationControl.timeStep):[],this.trajectory},a.prototype.selectAnimation=function(a){a||(a=0),this.generateTrajectory(a)},a.prototype.addTrajectory=function(a){if("undefined"!=typeof a.x&&"undefined"!=typeof a.y&&this.trajectory.push(a),"[object Array]"===Object.prototype.toString.call(a))for(var b in a)this.trajectory.push(a[b])},a.prototype.trajectorySize=function(){return this.trajectory.length},a.prototype.stepTrajectory=function(a){var b=a<this.trajectory.length?a:this.trajectory.length-1;this.trajectory[b]&&this.setPosition(this.trajectory[b])},a.prototype.lauchAnimation=function(a,b){0===this.trajectory.length&&this.selectAnimation(0);var c=_DerbySimulator.prototype.extend({resetAtTheEnd:!1},b),d=this.position;this.animationControl.currentKeyFrame=0,this.animationControl.done=!1,this.animationControl.maxKeyFrame=this.trajectory.length,this.animationControl.id=_DerbySimulator.prototype.getUUID();var e=this.animationControl,f=this;this.trajectory.length>0&&(this.animationControl.handler=window.setInterval(function(){e.currentKeyFrame++,e.currentKeyFrame>=e.maxKeyFrame?(window.clearInterval(e.handler),console.log("End of animation   "+e.id),f.animationControl.done=!0,c.resetAtTheEnd&&f.setPosition(d),a&&a()):f.stepTrajectory(e.currentKeyFrame)},this.animationControl.timeStep))},a.prototype.setTeam=function(a){this.team=a,a.players.indexOf(this)<0&&a.players.push(this),_DerbySimulator.prototype.addStyle(this.mark,{fill:a.color})},a.prototype.setText=function(a){for(var b=this.txt.childNodes,c=0;3>c;c++){var d=b[c].childNodes[0];d.nodeValue=a[c]?a[c]:""}},a.prototype.buildElement=function(){var a=new _DerbySimulator.prototype.SvgElement("g",{"class":"player "+this.role,transform:"translate("+this.position.x+", "+this.position.y+")",id:this.id});this.border=new _DerbySimulator.prototype.SvgElement("circle",{cx:0,cy:0,"class":"border",r:this.opt.ray});var b=new _DerbySimulator.prototype.SvgElement("g",{"class":"bulle",transform:"scale(2,2)"}),c=new _DerbySimulator.prototype.SvgElement("path",{d:"M0,0 l 15,-30 l -20,0 a 10,10,90,0,1,-10,-10 l 0,-60 a 10,10,90,0,1,10, -10 l 110,0 a 10,10,90,0,1,10,10 l 0,60 a 10,10,90,0,1,-10,10 l -70,0 L 0,0 z"});switch(this.txt=new _DerbySimulator.prototype.SvgElement("text",{x:0}),this.txt.appendChild(new _DerbySimulator.prototype.SvgElement("tspan",{x:0,y:-90},document.createTextNode(""))),this.txt.appendChild(new _DerbySimulator.prototype.SvgElement("tspan",{x:0,y:-90,dy:25},document.createTextNode(""))),this.txt.appendChild(new _DerbySimulator.prototype.SvgElement("tspan",{x:0,y:-90,dy:50},document.createTextNode(""))),b.appendChild(c),b.appendChild(this.txt),this.role){case"jammer":this.mark=new _DerbySimulator.prototype.SvgElement("polygon",{points:"0, 25 -5.878, 8.09 -23.776, 7.725 -9.511, -3.09 -14.695, -20.225 0, -10 14.695, -20.225 9.511, -3.09 23.776, 7.725 5.878, 8.09","class":"mark"});break;case"pivot":this.mark=new _DerbySimulator.prototype.SvgElement("rect",{x:-18,y:-8,width:36,height:16,style:"stroke:none","class":"mark"});break;case"blocker":default:this.mark=new _DerbySimulator.prototype.SvgElement("circle",{cx:0,cy:0,r:18,style:"stroke:none","class":"mark"})}return a.appendChild(this.border),a.appendChild(this.mark),a.appendChild(b),a},a.prototype.isInTrack=function(){var a=this,b=function(){for(var b=[],c=Math.PI/2;c<3*Math.PI/2;c+=Math.PI/36)b.push(new _DerbySimulator.prototype.Vector({x:(808-a.opt.ray)*Math.cos(c)-533,y:(808-a.opt.ray)*Math.sin(c)+31}));for(var d=3*Math.PI/2;d<5*Math.PI/2;d+=Math.PI/36)b.push(new _DerbySimulator.prototype.Vector({x:(808-a.opt.ray)*Math.cos(d)+533,y:(808-a.opt.ray)*Math.sin(d)-31}));return b},c=function(){for(var b=[],c=Math.PI/2;c<3*Math.PI/2;c+=Math.PI/36)b.push(new _DerbySimulator.prototype.Vector({x:(381+a.opt.ray)*Math.cos(c)-533,y:(381+a.opt.ray)*Math.sin(c)}));for(var d=3*Math.PI/2;d<5*Math.PI/2;d+=Math.PI/36)b.push(new _DerbySimulator.prototype.Vector({x:(381+a.opt.ray)*Math.cos(d)+533,y:(381+a.opt.ray)*Math.sin(d)}));return b};return _DerbySimulator.prototype.isPointInPoly(b(),this.position)&&!_DerbySimulator.prototype.isPointInPoly(c(),this.position)?(_DerbySimulator.prototype.addClass(this.getElement(),"in-track"),!0):(_DerbySimulator.prototype.removeClass(this.getElement(),"in-track"),!1)},a.prototype.getZone=function(a){var b=a?a:this.position;return b.x>=-533&&b.x<=533?b.y>0?2:4:b.x<-533?1:b.x>533?3:0},a.prototype.isInEngagementZone=function(){if(this.isInTrack()){if(this.setText("jammer"!==this.role?["Out of play"]:["In bounce"]),_DerbySimulator.prototype.removeClass(this.getElement(),"out-of-play"),null===this.scene.pack.players)return this.setText(["In bounce"]),!1;if(this.scene.pack.players.indexOf(this)>=0)return this.setText(["In the pack"]),!0;var a=this.trackAlgebraicDistance(this.scene.pack.forward.position);if(a>=0&&a<600+this.opt.ray+this.scene.pack.forward.opt.ray)return this.setText(["In the","engagement","zone"]),!0;var b=this.trackAlgebraicDistance(this.scene.pack.backyard.position);if(0>=b&&b>-600-this.opt.ray-this.scene.pack.backyard.opt.ray)return this.setText(["In the","engagement","zone"]),!0;if("jammer"===this.role){var c=this.trackAlgebraicDistance(this.scene.pack.backyard.position);this.scene.pack.length-c>0&&c>0&&this.setText(["In the pack"])}}else this.setText(["Out of","bounce"]);return"jammer"!==this.role&&_DerbySimulator.prototype.addClass(this.getElement(),"out-of-play"),!1},a.prototype.algebraicPosition=function(a){var b=a?a:this.position,c=534,d=2132+2*Math.PI*c,e=0;switch(this.getZone(b)){case 1:var f=Math.PI-(Math.atan(b.y/(b.x+533))+Math.PI/2)%Math.PI;e=c*f;break;case 2:e=Math.PI*c+533+b.x;break;case 3:var g=Math.PI/2-Math.atan(b.y/(b.x-533));e=Math.PI*c+1066+c*g;break;case 4:e=2*Math.PI*c+1599-b.x}return{position:e,total:d}},a.prototype.algebraicToCartesian=function(a){var b=534,c=2132+2*Math.PI*b,d=(2*c+a)%c;return d>0&&d<Math.PI*b?new _DerbySimulator.prototype.Vector({x:-533-b*Math.sin(d/b),y:-b*Math.cos(d/b)}):d>=Math.PI*b&&d<Math.PI*b+1066?new _DerbySimulator.prototype.Vector({x:d-Math.PI*b-533,y:b}):d>=Math.PI*b+1066&&d<2*Math.PI*b+1066?new _DerbySimulator.prototype.Vector({x:533+b*Math.sin((d-Math.PI*b-1066)/b),y:b*Math.cos((d-Math.PI*b-1066)/b)}):d>=2*Math.PI*b+1066?new _DerbySimulator.prototype.Vector({x:-(d-2*Math.PI*b-1599),y:-b}):void 0},a.prototype.trackAlgebraicDistance=function(a){var b=this.algebraicPosition(this.position),c=b.position,d=this.algebraicPosition(a).position,e=b.total,f={};f[Math.abs(c-d)]=c-d,f[Math.abs(c-e-d)%e]=(c-e-d)%e,f[Math.abs(c+e-d)%e]=(c+e-d)%e;var g=Object.keys(f).sort(function(a,b){return parseInt(a)>parseFloat(b)});return f[g[0]]},a.prototype.stringify=function(){var a=[];for(i in this.animations)a.push(this.animations[i].stringify());var b="["+a.join(",")+"]";return'{"name":"'+this.name+'","position":'+this.position.stringify()+',"animations":'+b+',"type":"'+this.humanType+'","role":"'+this.role+'"}'},a.prototype.loadAnimation=function(a,b){var c=_DerbySimulator.prototype.extend({marker:!1},b),d=null;switch(this.animations=[],a.type){case"bezier":d=new _DerbySimulator.prototype.AnimationBezier(this.scene,{marker:c.marker});break;default:d=new _DerbySimulator.prototype.AnimationLinear(this.scene,{marker:c.marker})}for(var e in a.keyframes)d.addKeyFrame(a.keyframes[e]);this.animations.push(d)},_DerbySimulator.prototype.Player=a}(),function(){var a=function(a){this.allObjects={},this.id=_DerbySimulator.prototype.getUUID(),this.opt=_DerbySimulator.prototype.extend({size:{width:3250,height:2e3},scale:1},a),this.opt.size.width*=this.opt.scale,this.opt.size.height*=this.opt.scale,this.element=this.buildElement(),this.track=new _DerbySimulator.prototype.Track(this),this.pack=new _DerbySimulator.prototype.Pack(this),this.allHumans=[],this.penaltyBox=new _DerbySimulator.prototype.PenaltyBox(this),this.benches={A:new _DerbySimulator.prototype.Bench(this,{position:0}),B:new _DerbySimulator.prototype.Bench(this,{position:1})},this.teams={A:new _DerbySimulator.prototype.Team(this,"A","red",0,this.benches.A),B:new _DerbySimulator.prototype.Team(this,"B","green",1,this.benches.B)},this.animationControl={done:!0}};a.prototype.addElement=function(a){this.container.appendChild(a)},a.prototype.registerObject=function(a){this.allObjects[a.id]=a},a.prototype.findObject=function(a){return this.allObjects[a]},a.prototype.getElement=function(){return this.element},a.prototype.buildElement=function(){var a=new _DerbySimulator.prototype.SvgElement("svg",{width:this.opt.size.width,height:this.opt.size.height,version:"1.1","class":"scene",id:this.id});a.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink","http://www.w3.org/1999/xlink"),this.container=new _DerbySimulator.prototype.SvgElement("g",{transform:"matrix("+this.opt.scale+" 0 0 "+this.opt.scale+" "+1500*this.opt.scale+" "+1e3*this.opt.scale+")"});var b=document.createElement("title");b.appendChild(document.createTextNode("Roller Derby"));var c=document.createElement("desc");return c.appendChild(document.createTextNode("Roller Derby Track")),a.appendChild(b),a.appendChild(c),a.appendChild(this.container),a},a.prototype.getInTrackPlayers=function(){var a=[];for(var b in this.allHumans)"player"===this.allHumans[b].humanType&&this.allHumans[b].isInTrack()&&a.push(this.allHumans[b]);return a},a.prototype.getOutTrackPlayers=function(){var a=[];for(var b in this.allHumans)"player"===this.allHumans[b].humanType&&(this.allHumans[b].isInTrack()||a.push(this.allHumans[b]));return a},a.prototype.stepAnimation=function(a){for(var b in this.allHumans)"undefined"!==this.allHumans[b].stepTrajectory&&this.allHumans[b].stepTrajectory(a)},a.prototype.maxKeyframe=function(){var a=0;for(var b in this.allHumans)a=Math.max(a,this.allHumans[b].trajectorySize());return a},a.prototype.launchAnimation=function(a,b){this.animationControl.done=!1,console.log("Starting animation "+this.animationControl.id);var c=this;for(var d in this.allHumans)this.allHumans[d].selectAnimation(a),this.allHumans[d].lauchAnimation(function(){if(!c.animationControl.done){for(var a in c.allHumans)if(c.allHumans[a].animationControl.currentKeyFrame<c.allHumans[a].animationControl.maxKeyFrame)return;b&&(c.animationControl.done=!0,b())}})},_DerbySimulator.prototype.Scene=a}(),function(){var a=function(a,b,c,d,e){this.id=_DerbySimulator.prototype.getUUID(),this.scene=a,a.registerObject(this),this.players=[],this.position=d,this.color=c,this.bench=e,this.addPlayer(new _DerbySimulator.prototype.Player(a,{position:e.chairs[0].position,role:"blocker",name:"B1-"+b})),this.addPlayer(new _DerbySimulator.prototype.Player(a,{position:e.chairs[1].position,role:"blocker",name:"B2-"+b})),this.addPlayer(new _DerbySimulator.prototype.Player(a,{position:e.chairs[2].position,role:"blocker",name:"B3-"+b})),this.addPlayer(new _DerbySimulator.prototype.Player(a,{position:e.chairs[3].position,role:"pivot",name:"P-"+b})),this.addPlayer(new _DerbySimulator.prototype.Player(a,{position:e.chairs[4].position,role:"jammer",name:"J-"+b}))};a.prototype.addPlayer=function(a){this.players.indexOf(a)<0&&this.players.push(a),a.setTeam(this)},a.prototype.stringify=function(){var a=[];for(var b in this.players)a.push(this.players[b].stringify());return'{"position":'+this.position+',"color":"'+this.color+'","players":['+a.join(",")+"]}"},_DerbySimulator.prototype.Team=a}(),function(){_DerbySimulator.prototype.extend=function(a,b){for(var c in b)a[c]=b[c];return a},_DerbySimulator.prototype.getUUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)})},_DerbySimulator.prototype.isPointInPoly=function(a,b){for(var c=!1,d=-1,e=a.length,f=e-1;++d<e;f=d)(a[d].y<=b.y&&b.y<a[f].y||a[f].y<=b.y&&b.y<a[d].y)&&b.x<(a[f].x-a[d].x)*(b.y-a[d].y)/(a[f].y-a[d].y)+a[d].x&&(c=!c);return c},_DerbySimulator.prototype.SvgElement=function(a,b,c){var d=document.createElementNS("http://www.w3.org/2000/svg",a);for(var e in b)d.setAttribute(e,b[e]);return c&&d.appendChild(c),d},_DerbySimulator.prototype.svgCross=function(a,b,c,d){var e=new _DerbySimulator.prototype.SvgElement("g",{"class":b,transform:"matrix(1 0 0 1 "+a.x+" "+a.y+")"});return e.appendChild(new _DerbySimulator.prototype.SvgElement("rect",{x:-c/2,y:-c/2,width:c,height:c})),"undefined"!=typeof d&&e.appendChild(new _DerbySimulator.prototype.SvgElement("text",{x:0,y:20,"text-anchor":"middle",style:"font-size:60px"},document.createTextNode(d))),e.appendChild(new _DerbySimulator.prototype.SvgElement("line",{x1:-c/2,y1:-c/2,x2:c/2,y2:c/2})),e.appendChild(new _DerbySimulator.prototype.SvgElement("line",{x1:c/2,y1:-c/2,x2:-c/2,y2:c/2})),e},_DerbySimulator.prototype.addStyle=function(a,b){var c=a.getAttribute("style"),d=c?c.split(";"):[],e={};for(var f in d)if(d[f].trim().length>0){var g=d[f].split(":"),h=g[0].trim(),i=g[1];e[h]=i}_DerbySimulator.prototype.extend(e,b),d="";for(var j in e)null!==e[j]&&(d+=j+":"+e[j]+";");a.setAttribute("style",d)},_DerbySimulator.prototype.addClass=function(a,b){var c=a.getAttribute("class"),d=c?c.split(" "):[];d.indexOf(b)<0&&d.push(b),a.setAttribute("class",d.join(" "))},_DerbySimulator.prototype.removeClass=function(a,b){var c=a.getAttribute("class"),d=c?c.split(" "):[];d.indexOf(b)>=0&&d.splice(d.indexOf(b),1),a.setAttribute("class",d.join(" "))}}(),function(){var a=function(a,b){this.id=_DerbySimulator.prototype.getUUID(),
this.scene=a,a.registerObject(this),this.opt=_DerbySimulator.prototype.extend({},b),this.element=this.buildElement(),a.addElement(this.element)};a.prototype.getElement=function(){return this.element},a.prototype.buildElement=function(){var a=new _DerbySimulator.prototype.SvgElement("g",{"class":"track","fill-rule":"evenodd",id:this.id});a.appendChild(new _DerbySimulator.prototype.SvgElement("path",{"class":"limit",d:"M -533,-777 l 1066,-62 a 808,808,180,1,1,0,1616 l -1066,62 a 808,808,180,1,1,0,-1616 z M -533,-381 l 1066,0 a 381,381,180,1,1,0,762 l -1066,0 a 381,381,180,1,1,0,-762 z"})),a.appendChild(new _DerbySimulator.prototype.SvgElement("path",{"class":"jam-line",d:"M -533,-381 l 0,-396"})),a.appendChild(new _DerbySimulator.prototype.SvgElement("path",{"class":"pivot-line",d:"M 382,-381 l 0,-450"})),a.appendChild(new _DerbySimulator.prototype.SvgElement("path",{"class":"three-meters",d:"M -233,-481 l 0,-200"})),a.appendChild(new _DerbySimulator.prototype.SvgElement("path",{"class":"three-meters",d:"M 67,-481 l 0,-200"})),a.appendChild(new _DerbySimulator.prototype.SvgElement("path",{"class":"three-meters",d:"M 533,481 l 0,200"})),a.appendChild(new _DerbySimulator.prototype.SvgElement("path",{"class":"three-meters",d:"M 233,481 l 0,200"})),a.appendChild(new _DerbySimulator.prototype.SvgElement("path",{"class":"three-meters",d:"M -67,481 l 0,200"})),a.appendChild(new _DerbySimulator.prototype.SvgElement("path",{"class":"three-meters",d:"M -367,481 l 0,200"}));for(var b=1;6>b;b++){var c=Math.cos(2.14*b/3.81),d=Math.sin(2.14*b/3.81),e=481,f=681;a.appendChild(new _DerbySimulator.prototype.SvgElement("path",{"class":"three-meters",d:"M "+Math.round(-533-e*d)+","+Math.round(-e*c)+" L "+Math.round(-533-f*d)+","+Math.round(-f*c)}))}for(var g=1;6>g;g++){var h=Math.cos(2.14*g/3.81),i=Math.sin(2.14*g/3.81),j=481,k=681;a.appendChild(new _DerbySimulator.prototype.SvgElement("path",{"class":"three-meters",d:"M "+Math.round(533+j*i)+","+Math.round(j*h)+" L "+Math.round(533+k*i)+","+Math.round(k*h)}))}return a},_DerbySimulator.prototype.Track=a}(),function(){var a=function(a){this.x=a.x?a.x:0,this.y=a.y?a.y:0,"undefined"!=typeof a.data&&(this.data=a.data)};a.prototype.distance=function(a){return Math.sqrt(Math.pow(this.x-a.x,2)+Math.pow(this.y-a.y,2))},a.prototype.add=function(a){return this.x+=a.x,this.y+=a.y,this},a.prototype.sub=function(a){return this.x-=a.x,this.y-=a.y,this},a.prototype.normalize=function(){var b=this.distance(new a({x:0,y:0}));return this.x/=b,this.y/=b,this},a.prototype.coef=function(a){return this.x*=a,this.y*=a,this},a.prototype.stringify=function(){return JSON.stringify({x:this.x,y:this.y})},_DerbySimulator.prototype.Vector=a}();